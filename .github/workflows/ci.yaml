name: MLC-LLM CI Pipeline

on:
  pull_request:
  push:
    branches: [ main ]
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.sha }}

# 1 Build & Push Docker Image
jobs:
  docker-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set lowercase image name
        run: |
          echo "IMAGE_NAME=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build \
            -t ghcr.io/${IMAGE_NAME}:${IMAGE_TAG} \
            -t ghcr.io/${IMAGE_NAME}:latest \
            -f docker/Dockerfile .

      - name: Push Docker image
        run: |
          docker push ghcr.io/${IMAGE_NAME}:${IMAGE_TAG}
          docker push ghcr.io/${IMAGE_NAME}:latest

# 2 Linux Build + Package
  linux-build:
    runs-on: ubuntu-latest
    needs: docker-image

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set lowercase image name
        run: |
          echo "IMAGE_NAME=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Pull Docker image
        run: |
          docker pull $REGISTRY/$IMAGE_NAME:$IMAGE_TAG

      - name: Build & package wheels
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/workspace \
            $REGISTRY/$IMAGE_NAME:$IMAGE_TAG \
            -lc "bash ./scripts/build.sh"

      - name: Upload Linux wheels
        uses: actions/upload-artifact@v4
        with:
          name: linux-wheels
          path: mlc-llm/python/dist/*.whl

# 3 Linux Tests
  linux-test:
    runs-on: ubuntu-latest
    needs: linux-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Linux wheels
        uses: actions/download-artifact@v4
        with:
          name: linux-wheels
          path: mlc-llm/dist
        
      - name: Set lowercase image name
        run: |
          echo "IMAGE_NAME=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Pull Docker image
        run: |
          docker pull $REGISTRY/$IMAGE_NAME:$IMAGE_TAG

      - name: Run tests
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/workspace \
            $REGISTRY/$IMAGE_NAME:$IMAGE_TAG \
            -lc "bash ./scripts/test.sh"

# 3 Release
  release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: [linux-test]

    steps:
      - name: Download Linux wheels
        uses: actions/download-artifact@v4
        with:
          name: linux-wheels
          path: linux-wheels

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            linux-wheels/*.whl

